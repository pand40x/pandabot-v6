import { Bot } from 'grammy';
import type { Context } from 'grammy';
import { logger } from '../../core/logger';

interface StockQuote {
  symbol: string;
  name: string;
  price: number;
  change: number;
  changePercent: number;
  currency: string;
  marketState: string;
  isMarketClosed: boolean;
}

// Initialize Yahoo Finance once
let yahooFinanceClient: any = null;

async function getYahooFinanceClient() {
  if (!yahooFinanceClient) {
    const YahooFinance = (await import('yahoo-finance2')).default;
    yahooFinanceClient = new YahooFinance({ suppressNotices: ['yahooSurvey'] });
  }
  return yahooFinanceClient;
}

async function fetchStockQuote(symbol: string): Promise<StockQuote> {
  try {
    const yf = await getYahooFinanceClient();
    
    // Only add .IS if explicitly requested OR if symbol is 4-5 chars AND doesn't contain a dot
    // (to avoid treating TSLA as Turkish stock)
    let searchSymbol = symbol;
    const hasDot = symbol.includes('.');
    
    // If it's a plain 4-5 char symbol without dots, it might be Turkish
    // But we need to be smart about this - let's try without .IS first, then with .IS
    if (!hasDot && symbol.length >= 4 && symbol.length <= 5) {
      // Try the symbol as-is first (might be US stock like TSLA, GOOG)
      try {
        const quoteData = await yf.quote(symbol);
        if (quoteData && (quoteData.regularMarketPrice || quoteData.regularMarketPreviousClose)) {
          // Success! Use this symbol
          searchSymbol = symbol;
        } else {
          // No data, try with .IS
          searchSymbol = `${symbol}.IS`;
        }
      } catch {
        // Symbol not found as-is, try with .IS
        searchSymbol = `${symbol}.IS`;
      }
    }
    
    const quoteData: any = await yf.quote(searchSymbol);
    
    if (!quoteData) {
      throw new Error(`Stock ${symbol} not found`);
    }
    
    // Use regularMarketPrice if available, otherwise use regularMarketPreviousClose
    const price = quoteData.regularMarketPrice || quoteData.regularMarketPreviousClose;
    
    if (!price) {
      throw new Error(`Stock ${symbol} not found`);
    }
    
    // Determine if market is open or closed
    const marketState = quoteData.marketState || 'UNKNOWN';
    const isMarketClosed = marketState === 'CLOSED';
    
    return {
      symbol: quoteData.symbol || searchSymbol,
      name: quoteData.shortName || symbol,
      price: price,
      change: quoteData.regularMarketChange || 0,
      changePercent: quoteData.regularMarketChangePercent || 0,
      currency: quoteData.currency || 'USD',
      marketState: marketState,
      isMarketClosed: isMarketClosed
    };
  } catch (error: any) {
    if (error.message?.includes('No data found') || error.message?.includes('not found')) {
      throw new Error(`Stock ${symbol} not found`);
    }
    throw error;
  }
}

async function fetchMultipleStocks(symbols: string[]): Promise<{ success: StockQuote[], failed: string[], errors: any[] }> {
  // yahoo-finance2 supports batch queries
  const quotes = await Promise.allSettled(
    symbols.map(symbol => fetchStockQuote(symbol))
  );
  
  const success: StockQuote[] = [];
  const failed: string[] = [];
  const errors: any[] = [];
  
  quotes.forEach((result, index) => {
    if (result.status === 'fulfilled') {
      success.push(result.value);
      logger.info(`Fetched successfully: ${symbols[index]}`, { service: 'pandabot' });
    } else {
      failed.push(symbols[index]);
      errors.push(result.reason);
      logger.error(`Failed to fetch ${symbols[index]}: ${result.reason?.message}`, { 
        service: 'pandabot',
        symbol: symbols[index],
        error: result.reason 
      });
    }
  });
  
  return { success, failed, errors };
}

function formatStockForTelegram(quote: StockQuote): string {
  const changeEmoji = quote.change >= 0 ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è';
  const changeFormatted = quote.change >= 0 ? `+${quote.change.toFixed(2)}` : quote.change.toFixed(2);
  const changePercentFormatted = quote.changePercent >= 0 ? `+${quote.changePercent.toFixed(2)}%` : `${quote.changePercent.toFixed(2)}%`;
  
  let marketStatus = '';
  if (quote.isMarketClosed) {
    marketStatus = '\n‚è∞ Piyasa Kapalƒ± (Son Kapanƒ±≈ü)';
  }
  
  return (
    `üìà ${quote.name} (${quote.symbol})\n` +
    `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
    `üí∞ Fiyat: ${quote.currency === 'TRY' ? '‚Ç∫' : '$'}${quote.price.toFixed(2)}\n` +
    `üìä Deƒüi≈üim: ${changeFormatted} (${changePercentFormatted}) ${changeEmoji}${marketStatus}\n` +
    `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`
  );
}

function formatMultipleStocksForTelegram(result: { success: StockQuote[], failed: string[], errors: any[] }, requestedCount: number): string {
  if (result.success.length === 0 && result.failed.length === 0) {
    return '‚ùå Hi√ßbir hisse senedi bulunamadƒ±.';
  }
  
  let message = `üìà Hisse Senetleri (${result.success.length}/${requestedCount})\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
  
  if (result.success.length > 0) {
    result.success.forEach(quote => {
      const changeEmoji = quote.change >= 0 ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è';
      const changeFormatted = quote.change >= 0 ? `+${quote.change.toFixed(2)}` : quote.change.toFixed(2);
      const changePercentFormatted = quote.changePercent >= 0 ? `+${quote.changePercent.toFixed(2)}%` : `${quote.changePercent.toFixed(2)}%`;
      const currencySymbol = quote.currency === 'TRY' ? '‚Ç∫' : '$';
      const marketStatus = quote.isMarketClosed ? ' ‚è∞' : '';
      
      message += `${quote.symbol}: ${currencySymbol}${quote.price.toFixed(2)} (${changeFormatted}, ${changePercentFormatted}) ${changeEmoji}${marketStatus}\n`;
    });
  }
  
  if (result.failed.length > 0) {
    message += '\n‚ùå *Ba≈üarƒ±sƒ±z:*\n';
    result.failed.forEach(symbol => {
      message += `‚Ä¢ ${symbol}: Piyasa kapalƒ± veya veri mevcut deƒüil\n`;
    });
  }
  
  message += '\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ';
  return message;
}

export function registerStocksHandlers(bot: Bot) {
  // /s command - Stock price query
  bot.command('s', async (ctx: Context) => {
    const input = (ctx.match as string | undefined)?.trim();
    
    if (!input) {
      await ctx.reply('üìà *Hisse Senedi Fiyatlarƒ±*\n' +
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n' +
        '/s AAPL              ‚Üí Apple\n' +
        '/s TSLA              ‚Üí Tesla\n' +
        '/s AAPL MSFT GOOGL   ‚Üí √áoklu sorgu\n' +
        '/s THYAO             ‚Üí T√ºrk hissesi\n' +
        '/s THYAO.IS          ‚Üí A√ßƒ±k format\n' +
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n' +
        '‚úÖ *Desteklenen Borsalar:*\n' +
        'üá∫üá∏ Amerikan borsasƒ± (NYSE, NASDAQ)\n' +
        '  ‚Ä¢ AAPL, MSFT, GOOGL, AMZN, TSLA, NVDA\n\n' +
        'üáπüá∑ T√ºrk borsasƒ± (BIST) - Sƒ±nƒ±rlƒ±\n' +
        '  ‚Ä¢ THYAO, AKBNK, GARAN, ISCTR, SAHOL\n' +
        '  ‚Ä¢ .IS eki ile: THYAO.IS, AKBNK.IS\n\n' +
        'üí° Not: Yahoo Finance T√ºrk borsasƒ± verilerini sƒ±nƒ±rlƒ± destekler.');
      return;
    }
    
    try {
      const symbols = input.split(' ').map(s => s.trim().toUpperCase());
      
      // Validate symbols (allow Turkish stocks with .IS suffix)
      const invalidSymbols = symbols.filter(symbol => !/^[A-Z]{1,5}(\.[A-Z]{1,2})?(\.IS)?$/.test(symbol));
      if (invalidSymbols.length > 0) {
        await ctx.reply(`‚ùå Ge√ßersiz semboller: ${invalidSymbols.join(', ')}\n\nGe√ßerli format: AAPL, MSFT, GOOGL, THYAO, THYAO.IS`);
        return;
      }
      
      await ctx.reply(`üìà Hisse senetleri y√ºkleniyor...`);
      
      if (symbols.length === 1) {
        // Single stock - detailed view
        const quote = await fetchStockQuote(symbols[0]!);
        await ctx.reply(formatStockForTelegram(quote));
      } else {
        // Multiple stocks - compact view
        const result = await fetchMultipleStocks(symbols);
        await ctx.reply(formatMultipleStocksForTelegram(result, symbols.length));
      }
      
    } catch (error: any) {
      logger.error('Error fetching stock price:', error);
      
      if (error.code === 'ECONNABORTED') {
        await ctx.reply('‚ùå ƒ∞stek zaman a≈üƒ±mƒ±na uƒüradƒ±. L√ºtfen tekrar deneyin.');
      } else if (error.message?.includes('not found')) {
        const inputSymbol = input.split(' ')[0]?.toUpperCase();
        if (inputSymbol && inputSymbol.match(/^[A-Z]{4,5}$/)) {
          await ctx.reply(`‚ùå ${inputSymbol} hisse senedi bulunamadƒ±.\n\nüìù Not: Yahoo Finance T√ºrk borsasƒ± verilerini sƒ±nƒ±rlƒ± ≈üekilde destekler. L√ºtfen .IS ekleyerek deneyin:\n/s ${inputSymbol}.IS\n\n‚úÖ Desteklenen borsalar:\n‚Ä¢ Amerikan borsasƒ±: AAPL, TSLA, MSFT, GOOGL\n‚Ä¢ T√ºrk borsasƒ±: Bazƒ± hisseler (.IS ile)`);
        } else {
          await ctx.reply('‚ùå Hisse senedi bulunamadƒ±. Sembol√º kontrol edin.\n\n√ñrnek: /s AAPL\n/s TSLA\n/s THYAO.IS');
        }
      } else {
        await ctx.reply('‚ùå Hisse senedi fiyatƒ± alƒ±namadƒ±. L√ºtfen tekrar deneyin.');
      }
    }
  });
  
  // /stock alias for /s
  bot.command('stock', async (ctx: Context) => {
    const input = (ctx.match as string | undefined)?.trim();
    
    if (!input) {
      await ctx.reply('‚ùì Hisse senedi sembol√º belirtin:\n/stock AAPL\n/stock TSLA\n/stock NVDA\n\nYardƒ±m i√ßin /s komutunu kullanabilirsiniz.');
      return;
    }
    
    // Process the same as /s command
    ctx.match = input;
    // Re-use the /s command logic
    const symbols = input.split(' ').map(s => s.trim().toUpperCase());
    
    try {
      const invalidSymbols = symbols.filter(symbol => !/^[A-Z]{1,5}(\.[A-Z]{1,2})?(\.IS)?$/.test(symbol));
      if (invalidSymbols.length > 0) {
        await ctx.reply(`‚ùå Ge√ßersiz semboller: ${invalidSymbols.join(', ')}\n\nGe√ßerli format: AAPL, MSFT, GOOGL, THYAO, THYAO.IS`);
        return;
      }
      
      await ctx.reply(`üìà Hisse senetleri y√ºkleniyor...`);
      
      if (symbols.length === 1) {
        const quote = await fetchStockQuote(symbols[0]!);
        await ctx.reply(formatStockForTelegram(quote));
      } else {
        const result = await fetchMultipleStocks(symbols);
        await ctx.reply(formatMultipleStocksForTelegram(result, symbols.length));
      }
      
    } catch (error: any) {
      logger.error('Error fetching stock price:', error);
      
      if (error.code === 'ECONNABORTED') {
        await ctx.reply('‚ùå ƒ∞stek zaman a≈üƒ±mƒ±na uƒüradƒ±. L√ºtfen tekrar deneyin.');
      } else if (error.message?.includes('not found')) {
        await ctx.reply('‚ùå Hisse senedi bulunamadƒ±. Sembol√º kontrol edin.\n\n√ñrnek: /stock AAPL');
      } else {
        await ctx.reply('‚ùå Hisse senedi fiyatƒ± alƒ±namadƒ±. L√ºtfen tekrar deneyin.');
      }
    }
  });
}
